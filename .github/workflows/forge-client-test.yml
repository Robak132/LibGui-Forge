name: Forge Client Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  forge-client-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      DISPLAY: :1
      IMGUR_CLIENT_ID: ${{ secrets.IMGUR_CLIENT_ID }}
      MC_MAIN: .minecraft
      MC_WORK: profile

    steps:
      - uses: actions/checkout@v4

      # Cache Minecraft installation (assets, libs, Forge files)
      - name: Cache Minecraft data
        id: cache-mc
        uses: actions/cache@v4
        with:
          path: |
            .minecraft
            profile
          key: mc-forge-1.20.1-${{ hashFiles('**/*.toml', '**/mods/**', '**/*.mrpack') }}
          restore-keys: |
            mc-forge-1.20.1-

      # Cache pip portablemc install
      - name: Cache pip
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: pip-portablemc-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            pip-portablemc-${{ runner.os }}-

      # Install system deps + Xvfb
      - name: Setup system
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb x11-apps imagemagick libxtst6 libxi6
          echo "DISPLAY=:1" >> $GITHUB_ENV
          sudo Xvfb :1 -screen 0 854x480x24 >/dev/null 2>&1 &
          sleep 2

      # Ensure dirs exist
      - name: Init directories
        run: |
          mkdir -p "$MC_MAIN"
          mkdir -p "$MC_WORK"

      # Setup Python
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install portablemc (cached on next run)
      - name: Install portablemc
        if: steps.cache-pip.outputs.cache-hit != 'true'
        run: |
          pip install --user portablemc
        # Add to PATH always
      - name: Ensure portablemc PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Install Forge client (skipped if cache restored)
      - name: Install Forge client
        if: steps.cache-mc.outputs.cache-hit != 'true'
        run: |
          portablemc --main-dir "$MC_MAIN" --work-dir "$MC_WORK" \
            start forge:1.20.1 --dry

      # Install modpack (runs every time; do NOT cache modpack)
      - name: Install modpack
        run: |
          echo "Place Forge modpack installation here"
          # Example:
          # mkdir -p "$MC_MAIN/mods"
          # cp mods/*.jar "$MC_MAIN/mods/"

      # Run Forge client
      - name: Run client
        continue-on-error: true
        timeout-minutes: 8
        run: |
          portablemc --main-dir "$MC_MAIN" --work-dir "$MC_WORK" \
            start forge:1.20.1 \
            --jvm "$(dirname $(which java))/java" \
            -u Tester --window &> client.log &
          sleep 35

      # Screenshot
      - name: Screenshot
        run: |
          xwd -display $DISPLAY -root -silent | convert xwd:- png:screenshot.png

      # Upload to Imgur
      - name: Upload screenshot
        id: upload
        run: |
          resp=$(curl -s -H "Authorization: Client-ID $IMGUR_CLIENT_ID" \
            -F "image=@screenshot.png" https://api.imgur.com/3/upload)
          echo "$resp" > imgur.json
          echo "url=$(jq -r '.data.link' imgur.json)" >> $GITHUB_OUTPUT

      # Summary
      - name: Summary
        run: |
          echo "## Forge Client Screenshot" >> $GITHUB_STEP_SUMMARY
          echo "![](${{ steps.upload.outputs.url }})" >> $GITHUB_STEP_SUMMARY

      # PR comment
      - uses: mshick/add-pr-comment@v2
        if: github.event_name == 'pull_request'
        with:
          message-id: "forge-client-test"
          message: |
            ### Forge Client Test
            ![](${{ steps.upload.outputs.url }})
