name: Forge Client Test

on:
  pull_request:
  workflow_dispatch:

jobs:
  forge-client-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      DISPLAY: :1
      IMGUR_CLIENT_ID: ${{ secrets.IMGUR_CLIENT_ID }}
      MC_MAIN: .minecraft
      MC_WORK: profile

    steps:
      - uses: actions/checkout@v4

      # Cache Minecraft installation
      - name: Cache Minecraft data
        id: cache-mc
        uses: actions/cache@v4
        with:
          path: |
            .minecraft
            profile
          key: mc-forge-1.20.1-${{ hashFiles('**/mods/**', '**/*.mrpack', '**/*.toml') }}
          restore-keys: |
            mc-forge-1.20.1-

      # Cache pip portablemc install
      - name: Cache portablemc
        id: cache-pip
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: pip-portablemc-${{ runner.os }}
          restore-keys: |
            pip-portablemc-${{ runner.os }}

      # System deps + Xvfb + GL libs
      - name: Setup system
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb x11-apps imagemagick libxtst6 libxi6 \
            libgl1-mesa-glx libgl1-mesa-dri libglu1-mesa
          echo "DISPLAY=:1" >> $GITHUB_ENV
          sudo Xvfb :1 -screen 0 1280x720x24 >/dev/null 2>&1 &
          sleep 2

      # Ensure dirs exist
      - name: Init dirs
        run: |
          mkdir -p "$MC_MAIN"
          mkdir -p "$MC_WORK"

      # Python + portablemc
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install portablemc
        if: steps.cache-pip.outputs.cache-hit != 'true'
        run: |
          pip install --user portablemc

      - name: Ensure portablemc PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Install Forge client (skip if cache used)
      - name: Install Forge client
        if: steps.cache-mc.outputs.cache-hit != 'true'
        run: |
          portablemc --main-dir "$MC_MAIN" --work-dir "$MC_WORK" \
            start forge:1.20.1 --dry

      # Install modpack (you customize this)
      - name: Install modpack
        run: |
          echo "Place Forge modpack installation logic here"
          # Example:
          # mkdir -p "$MC_MAIN/mods"
          # cp mods/*.jar "$MC_MAIN/mods/"

      # Run Forge client
      - name: Run client
        timeout-minutes: 10
        run: |
          portablemc --main-dir "$MC_MAIN" --work-dir "$MC_WORK" \
            start forge:1.20.1 \
            --jvm "$(dirname $(which java))/java" \
            -u Tester --window &> client.log &
          
          # Allow Forge time to fully initialize and render
          echo "Waiting for Forge to start..."
          sleep 300

      # Detect Forge crash reports
      - name: Check for crash
        run: |
          if ls .minecraft/crash-reports/*.txt 2>/dev/null; then
            echo "Forge crash detected!"
            cat .minecraft/crash-reports/*.txt
            exit 1
          fi

      # Screenshot actual window
      - name: Screenshot window
        run: |
          echo "Looking for Minecraft window..."
          xwininfo -root -tree > windows.txt
          cat windows.txt

          WIN_ID=$(awk '/minecraft|java|LWJGL|forge/i {print $1}' windows.txt | head -n 1)

          if [ -z "$WIN_ID" ]; then
            echo "ERROR: No Minecraft window found."
            exit 1
          fi

          echo "Found window: $WIN_ID"
          xwd -id "$WIN_ID" -silent | convert xwd:- png:screenshot.png

      # Upload screenshot to Imgur
      - name: Upload screenshot
        id: upload
        run: |
          resp=$(curl -s -H "Authorization: Client-ID $IMGUR_CLIENT_ID" \
            -F "image=@screenshot.png" https://api.imgur.com/3/upload)
          echo "$resp" > imgur.json
          echo "url=$(jq -r '.data.link' imgur.json)" >> $GITHUB_OUTPUT

      # Summary
      - name: Summary
        run: |
          echo "## Forge Client Screenshot" >> $GITHUB_STEP_SUMMARY
          echo "![](${{ steps.upload.outputs.url }})" >> $GITHUB_STEP_SUMMARY

      # PR comment
      - uses: mshick/add-pr-comment@v2
        if: github.event_name == 'pull_request'
        with:
          message-id: "forge-client-test"
          message: |
            ### Forge Client Test
            ![](${{ steps.upload.outputs.url }})
